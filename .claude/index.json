{
  "project": {
    "name": "eSIM-Tools",
    "version": "2.0.0",
    "description": "专为 Giffgaff 和 Simyo 用户设计的 eSIM 管理工具集",
    "type": "Serverless Web Application",
    "platform": "Netlify (JAMstack + Functions)",
    "lastScanned": "2025-12-11T14:19:54.000Z"
  },
  "architecture": {
    "frontend": "原生 JavaScript (ES2021+) + 模块化组件",
    "backend": "Serverless (Netlify Functions + Edge Functions)",
    "buildTools": "Webpack 5 + Babel + PostCSS",
    "deployment": "JAMstack (静态托管 + Serverless API)"
  },
  "modules": [
    {
      "name": "Giffgaff 前端模块",
      "path": "src/giffgaff/",
      "type": "frontend",
      "language": "JavaScript",
      "documentation": "src/giffgaff/CLAUDE.md",
      "responsibility": "实现 Giffgaff eSIM 管理流程",
      "features": [
        "OAuth 2.0 PKCE 登录流程",
        "MFA 双通道验证（EMAIL/SMS）",
        "eSIM 预订与激活",
        "Cookie 自动刷新机制",
        "GraphQL API 交互"
      ],
      "keyFiles": [
        "src/giffgaff/giffgaff_modular.html",
        "src/giffgaff/js/giffgaff-app.js",
        "src/giffgaff/js/modules/oauth-handler.js",
        "src/giffgaff/js/modules/mfa-handler.js",
        "src/giffgaff/js/modules/esim-service.js",
        "src/giffgaff/js/modules/state-manager.js",
        "src/giffgaff/js/modules/ui-controller.js"
      ],
      "entryPoint": "src/giffgaff/giffgaff_modular.html",
      "tests": "tests/giffgaff/",
      "dependencies": [
        "src/js/modules/logger.js",
        "src/js/modules/i18n.js"
      ]
    },
    {
      "name": "Simyo 前端模块",
      "path": "src/simyo/",
      "type": "frontend",
      "language": "JavaScript",
      "documentation": "src/simyo/CLAUDE.md",
      "responsibility": "实现 Simyo eSIM 管理流程",
      "features": [
        "用户认证（用户名/密码）",
        "eSIM 预订与激活",
        "设备变更处理",
        "API 请求代理（通过 Netlify Redirects）"
      ],
      "keyFiles": [
        "src/simyo/simyo_modular.html",
        "src/simyo/js/simyo-app.js",
        "src/simyo/js/modules/auth-handler.js",
        "src/simyo/js/modules/esim-service.js",
        "src/simyo/js/modules/device-change-handler.js",
        "src/simyo/js/modules/state-manager.js",
        "src/simyo/js/modules/ui-controller.js"
      ],
      "entryPoint": "src/simyo/simyo_modular.html",
      "proxy": {
        "from": "/api/simyo/*",
        "to": "https://appapi.simyo.nl"
      }
    },
    {
      "name": "通用工具模块",
      "path": "src/js/modules/",
      "type": "frontend-utils",
      "language": "JavaScript",
      "documentation": "src/js/modules/CLAUDE.md",
      "responsibility": "提供可复用的前端工具模块",
      "modules": [
        {
          "name": "Logger",
          "file": "logger.js",
          "purpose": "环境感知日志（生产环境自动禁用）"
        },
        {
          "name": "API Service",
          "file": "api-service.js",
          "purpose": "统一 HTTP 客户端（重试/缓存/去重）"
        },
        {
          "name": "Secure Storage",
          "file": "secure-storage.js",
          "purpose": "加密本地存储"
        },
        {
          "name": "HTML Sanitizer",
          "file": "html-sanitizer.js",
          "purpose": "XSS 防护"
        },
        {
          "name": "Performance Monitor",
          "file": "performance-monitor.js",
          "purpose": "性能监控"
        },
        {
          "name": "i18n",
          "file": "i18n.js",
          "purpose": "国际化支持"
        },
        {
          "name": "Notification Manager",
          "file": "notification-manager.js",
          "purpose": "通知管理"
        },
        {
          "name": "Captcha Manager",
          "file": "captcha-manager.js",
          "purpose": "验证码集成（Turnstile/reCAPTCHA）"
        }
      ],
      "keyFiles": [
        "src/js/modules/logger.js",
        "src/js/modules/api-service.js",
        "src/js/modules/secure-storage.js",
        "src/js/modules/html-sanitizer.js",
        "src/js/modules/performance-monitor.js",
        "src/js/modules/i18n.js",
        "src/js/modules/notification-manager.js",
        "src/js/modules/captcha-manager.js"
      ]
    },
    {
      "name": "Netlify Functions",
      "path": "netlify/functions/",
      "type": "backend-functions",
      "language": "JavaScript (Node.js)",
      "documentation": "netlify/functions/CLAUDE.md",
      "responsibility": "Serverless 后端逻辑实现",
      "features": [
        "OAuth Token 交换",
        "Cookie 验证与 Token 提取",
        "GraphQL API 代理（带智能头部注入）",
        "MFA 双通道验证（EMAIL/SMS）",
        "eSIM 激活端到端流程",
        "健康检查与配置下发",
        "通知系统 API"
      ],
      "functions": [
        {
          "name": "giffgaff-token-exchange",
          "purpose": "OAuth Token 交换",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "verify-cookie",
          "purpose": "Cookie 验证与 Token 提取",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "giffgaff-graphql",
          "purpose": "GraphQL 代理（自动 Token 刷新）",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "giffgaff-mfa-challenge",
          "purpose": "MFA 验证码发送（双通道）",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "giffgaff-mfa-validation",
          "purpose": "MFA 验证码验证",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "giffgaff-sms-activate",
          "purpose": "SMS 激活端到端流程",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "auto-activate-esim",
          "purpose": "网页激活（浏览器流程模拟）",
          "method": "POST",
          "authentication": true
        },
        {
          "name": "health",
          "purpose": "健康检查",
          "method": "GET/POST",
          "authentication": false
        },
        {
          "name": "public-config",
          "purpose": "公共配置下发（验证码配置）",
          "method": "GET",
          "authentication": false
        },
        {
          "name": "notifications",
          "purpose": "通知 API（需认证）",
          "method": "GET",
          "authentication": true
        },
        {
          "name": "notifications-internal",
          "purpose": "内部通知 API（无需认证）",
          "method": "GET",
          "authentication": false
        }
      ],
      "keyFiles": [
        "netlify/functions/giffgaff-token-exchange.js",
        "netlify/functions/verify-cookie.js",
        "netlify/functions/giffgaff-graphql.js",
        "netlify/functions/giffgaff-mfa-challenge.js",
        "netlify/functions/giffgaff-mfa-validation.js",
        "netlify/functions/giffgaff-sms-activate.js",
        "netlify/functions/auto-activate-esim.js",
        "netlify/functions/health.js",
        "netlify/functions/public-config.js",
        "netlify/functions/notifications.js",
        "netlify/functions/notifications-internal.js"
      ],
      "middleware": "netlify/functions/_shared/middleware.js"
    },
    {
      "name": "Edge Functions (BFF Proxy)",
      "path": "netlify/edge-functions/",
      "type": "backend-edge",
      "language": "JavaScript (Deno)",
      "documentation": "netlify/edge-functions/CLAUDE.md",
      "responsibility": "边缘层 BFF 代理（密钥注入与验证码验证）",
      "features": [
        "ACCESS_KEY 密钥注入（保护后端 Functions）",
        "Turnstile/reCAPTCHA 验证码验证",
        "请求路由（/bff/* → /.netlify/functions/*）",
        "全球边缘节点部署（低延迟）",
        "无状态代理（请求透传）"
      ],
      "functions": [
        {
          "name": "bff-proxy",
          "purpose": "BFF 代理层",
          "pattern": "/bff/*",
          "authentication": "Edge-level (ACCESS_KEY injection)"
        }
      ],
      "keyFiles": [
        "netlify/edge-functions/bff-proxy.js"
      ],
      "runtime": "Deno (Edge-native)",
      "deployment": "Netlify Edge Network (Global)"
    },
    {
      "name": "Netlify Functions 中间件",
      "path": "netlify/functions/_shared/",
      "type": "backend-middleware",
      "language": "JavaScript (Node.js)",
      "documentation": "netlify/functions/_shared/CLAUDE.md",
      "responsibility": "提供 Netlify Functions 统一中间件层",
      "features": [
        "统一鉴权（ACCESS_KEY 验证）",
        "CORS 处理",
        "Schema 驱动的输入验证",
        "统一错误处理",
        "标准响应格式"
      ],
      "keyFiles": [
        "netlify/functions/_shared/middleware.js"
      ],
      "exports": [
        "withAuth",
        "authenticate",
        "validateInput",
        "createHeaders",
        "handleError",
        "fetchWithTimeout",
        "AuthError"
      ],
      "impact": "减少 400+ 行重复代码，代码减少 25%"
    },
    {
      "name": "构建脚本模块",
      "path": "scripts/",
      "type": "build-scripts",
      "language": "JavaScript (Node.js)",
      "documentation": "scripts/CLAUDE.md",
      "responsibility": "构建、质量检查、安全扫描和自动化",
      "scripts": [
        {
          "name": "logger.js",
          "purpose": "构建日志模块（彩色输出）",
          "command": "require('./logger.js')"
        },
        {
          "name": "build-static.js",
          "purpose": "Webpack 打包与资源优化",
          "command": "npm run build"
        },
        {
          "name": "optimize-images.js",
          "purpose": "Sharp 图片压缩",
          "command": "npm run optimize-images"
        },
        {
          "name": "compress.js",
          "purpose": "Gzip/Brotli 压缩",
          "command": "npm run compress"
        },
        {
          "name": "quality-check.js",
          "purpose": "代码质量检查（14项）",
          "command": "npm run quality-check",
          "checks": [
            "语法检查",
            "环境变量一致性",
            "依赖完整性",
            "安全配置",
            "代码风格",
            "日志规范",
            "错误处理",
            "Netlify 配置",
            "文件命名",
            "导入路径",
            "代码复杂度",
            "函数长度",
            "注释覆盖率",
            "测试覆盖率"
          ]
        },
        {
          "name": "security-check.js",
          "purpose": "安全配置扫描",
          "command": "npm run security-check",
          "checks": [
            "环境变量泄露",
            "依赖漏洞",
            "弱密钥",
            "敏感文件",
            "CORS 配置"
          ]
        },
        {
          "name": "deploy-prepare.js",
          "purpose": "部署准备（质量+安全+构建）",
          "command": "npm run deploy-prepare"
        },
        {
          "name": "test-deploy-config.js",
          "purpose": "Netlify 配置验证",
          "command": "npm run deploy-test"
        }
      ],
      "keyFiles": [
        "scripts/logger.js",
        "scripts/build-static.js",
        "scripts/quality-check.js",
        "scripts/security-check.js",
        "scripts/optimize-images.js",
        "scripts/compress.js",
        "scripts/deploy-prepare.js",
        "scripts/test-deploy-config.js"
      ]
    },
    {
      "name": "测试模块",
      "path": "tests/",
      "type": "tests",
      "language": "JavaScript",
      "framework": "Jest 29.7.0",
      "environment": "jsdom",
      "responsibility": "单元测试和集成测试",
      "testFiles": [
        "tests/giffgaff/state.test.js",
        "tests/giffgaff/oauth.test.js",
        "tests/giffgaff/utils.test.js"
      ],
      "coverage": {
        "state-manager": "完整（重置、保存、加载、过期处理）",
        "oauth-handler": "完整（Code Verifier/Challenge、URL 构建、Token 交换）",
        "utils": "完整（Cookie 操作、服务时间、剪贴板、QR 码生成）"
      },
      "commands": {
        "runAll": "npm test",
        "watch": "npm run test:watch",
        "coverage": "npm run test:coverage"
      }
    }
  ],
  "ignoreRules": {
    "source": ".gitignore",
    "patterns": [
      "node_modules/**",
      ".git/**",
      ".github/**",
      "dist/**",
      "build/**",
      ".next/**",
      "__pycache__/**",
      "*.lock",
      "*.log",
      "*.bin",
      "*.pdf",
      "*.png",
      "*.jpg",
      "*.jpeg",
      "*.gif",
      "*.mp4",
      "*.zip",
      "*.tar",
      "*.gz",
      ".env",
      ".env.*",
      "coverage/",
      ".netlify/"
    ]
  },
  "coverage": {
    "totalFilesEstimated": 120,
    "scannedFiles": 92,
    "coveragePercentage": 77,
    "moduleCoverage": {
      "giffgaff": {
        "status": "完整",
        "keyFilesScanned": 7,
        "missingItems": []
      },
      "simyo": {
        "status": "完整",
        "keyFilesScanned": 6,
        "missingItems": []
      },
      "commonModules": {
        "status": "完整",
        "keyFilesScanned": 8,
        "missingItems": []
      },
      "functions": {
        "status": "完整",
        "keyFilesScanned": 12,
        "missingItems": [],
        "note": "已扫描全部 11 个 Functions 实现 + 中间件"
      },
      "edgeFunctions": {
        "status": "完整",
        "keyFilesScanned": 1,
        "missingItems": [],
        "note": "已扫描 BFF Proxy 实现"
      },
      "scripts": {
        "status": "完整",
        "keyFilesScanned": 8,
        "missingItems": []
      },
      "tests": {
        "status": "完整",
        "keyFilesScanned": 3,
        "missingItems": [],
        "note": "已扫描 state、oauth、utils 测试文件"
      },
      "config": {
        "status": "完整",
        "keyFilesScanned": 3,
        "missingItems": [],
        "note": "已扫描 webpack.config.js, netlify.toml, package.json"
      }
    }
  },
  "nextSteps": [
    "扫描 src/styles/ CSS 样式文件",
    "扫描 docs/ 中现有文档",
    "补充模块间依赖关系分析",
    "生成 API 调用流程图"
  ],
  "recommendations": [
    "建议增加：E2E 测试覆盖（当前仅有单元测试）",
    "建议增加：API 文档生成（基于 Schema 和中间件）",
    "建议增加：性能监控集成（当前仅有工具，未集成监控平台）",
    "建议优化：添加 Functions 单元测试（当前仅测试前端模块）"
  ],
  "metadata": {
    "generatedBy": "Claude Code (Sonnet 4.5)",
    "timestamp": "2025-12-11T14:19:54.000Z",
    "version": "2.0.0",
    "format": "claude-index-v1"
  }
}
