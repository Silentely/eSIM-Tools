# Giffgaff eSIM å·¥å…· - æ¨¡å—æ¶æ„è¯´æ˜

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    giffgaff_modular.html                    â”‚
â”‚                     (HTMLç»“æ„å±‚)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CSSæ ·å¼å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ giffgaff-base.css         (åŸºç¡€æ ·å¼)                     â”‚
â”‚  â€¢ giffgaff-components.css   (ç»„ä»¶æ ·å¼)                     â”‚
â”‚  â€¢ giffgaff-service-time.css (æœåŠ¡æ—¶é—´)                     â”‚
â”‚  â€¢ giffgaff-animations.css   (åŠ¨ç”»æ•ˆæœ)                     â”‚
â”‚  â€¢ giffgaff-responsive.css   (å“åº”å¼)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   giffgaff-app.js                           â”‚
â”‚                  (åº”ç”¨ä¸»å…¥å£)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ ¸å¿ƒæœåŠ¡å±‚          â”‚       â”‚   UIæ§åˆ¶å±‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ oauth-handler.js    â”‚       â”‚ â€¢ ui-controller.js    â”‚
â”‚ â€¢ cookie-handler.js   â”‚       â”‚                       â”‚
â”‚ â€¢ mfa-handler.js      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ esim-service.js     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
        â”‚                                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŸºç¡€è®¾æ–½å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ state-manager.js    (çŠ¶æ€ç®¡ç†)                           â”‚
â”‚  â€¢ api-config.js       (APIé…ç½®)                            â”‚
â”‚  â€¢ utils.js            (å·¥å…·å‡½æ•°)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ¨¡å—è¯¦ç»†è¯´æ˜

### ç¬¬ä¸€å±‚ï¼šåŸºç¡€è®¾æ–½å±‚

#### 1. state-manager.js
**èŒè´£ï¼š** åº”ç”¨çŠ¶æ€çš„å”¯ä¸€çœŸå®æ¥æº

**æä¾›ï¼š**
- çŠ¶æ€å­˜å‚¨å’Œè®¿é—®
- çŠ¶æ€æŒä¹…åŒ–ï¼ˆlocalStorageï¼‰
- çŠ¶æ€å˜æ›´é€šçŸ¥ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰
- Cookieç®¡ç†

**ä¾èµ–ï¼š** æ— 

**è¢«ä¾èµ–ï¼š** æ‰€æœ‰ä¸šåŠ¡æ¨¡å—

```javascript
// çŠ¶æ€ç»“æ„
{
    accessToken: string,
    codeVerifier: string,
    cookie: string,
    emailCodeRef: string,
    emailSignature: string,
    memberId: string,
    memberName: string,
    phoneNumber: string,
    esimSSN: string,
    esimActivationCode: string,
    esimDeliveryStatus: string,
    lpaString: string,
    isDeviceChange: boolean,
    currentStep: number
}
```

#### 2. api-config.js
**èŒè´£ï¼š** é›†ä¸­ç®¡ç†APIé…ç½®

**æä¾›ï¼š**
- OAuthé…ç½®
- APIç«¯ç‚¹å®šä¹‰
- GraphQLæŸ¥è¯¢æ¨¡æ¿

**ä¾èµ–ï¼š** utils.js (ç¯å¢ƒæ£€æµ‹)

**è¢«ä¾èµ–ï¼š** æ‰€æœ‰æœåŠ¡æ¨¡å—

#### 3. utils.js
**èŒè´£ï¼š** é€šç”¨å·¥å…·å‡½æ•°

**æä¾›ï¼š**
- PKCEå‚æ•°ç”Ÿæˆ
- æœåŠ¡æ—¶é—´æ£€æŸ¥
- å‰ªè´´æ¿æ“ä½œ
- Toasté€šçŸ¥
- ç¯å¢ƒæ£€æµ‹

**ä¾èµ–ï¼š** æ— 

**è¢«ä¾èµ–ï¼š** æ‰€æœ‰æ¨¡å—

### ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒæœåŠ¡å±‚

#### 4. oauth-handler.js
**èŒè´£ï¼š** OAuth 2.0 PKCEè®¤è¯æµç¨‹

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `startOAuthLogin()` - å¯åŠ¨OAuthç™»å½•
- `processCallback()` - å¤„ç†OAuthå›è°ƒ

**ä¾èµ–ï¼š**
- state-manager.js
- api-config.js
- utils.js

**æ•°æ®æµï¼š**
```
ç”¨æˆ·ç‚¹å‡»ç™»å½•
    â†“
ç”ŸæˆPKCEå‚æ•° (utils)
    â†“
ä¿å­˜åˆ°çŠ¶æ€ (state-manager)
    â†“
æ‰“å¼€æˆæƒé¡µé¢
    â†“
ç”¨æˆ·æˆæƒå¹¶è·å–å›è°ƒURL
    â†“
è§£æcodeå’Œstate
    â†“
äº¤æ¢è®¿é—®ä»¤ç‰Œ (api-config)
    â†“
ä¿å­˜ä»¤ç‰Œ (state-manager)
```

#### 5. cookie-handler.js
**èŒè´£ï¼š** CookieéªŒè¯å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `verifyCookie()` - éªŒè¯Cookieæœ‰æ•ˆæ€§
- `checkCookieValidity()` - å®šæœŸæ£€æŸ¥
- `startValidityMonitor()` - å¯åŠ¨ç›‘æ§
- `stopValidityMonitor()` - åœæ­¢ç›‘æ§
- `handleCookieExpired()` - å¤„ç†è¿‡æœŸ

**ä¾èµ–ï¼š**
- state-manager.js
- api-config.js

**ç›‘æ§æœºåˆ¶ï¼š**
```
CookieéªŒè¯æˆåŠŸ
    â†“
å¯åŠ¨å®šæ—¶å™¨ï¼ˆ5åˆ†é’Ÿé—´éš”ï¼‰
    â†“
å®šæœŸè°ƒç”¨éªŒè¯API
    â†“
å¦‚æœ401 â†’ è§¦å‘è¿‡æœŸå¤„ç†
    â†“
æ¸…é™¤çŠ¶æ€å¹¶é€šçŸ¥UI
```

#### 6. mfa-handler.js
**èŒè´£ï¼š** å¤šå› ç´ è®¤è¯æµç¨‹

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `sendMFAChallenge()` - å‘é€éªŒè¯ç 
- `validateMFACode()` - éªŒè¯éªŒè¯ç 
- `sendSimSwapMFAChallenge()` - SIMäº¤æ¢éªŒè¯ç 

**ä¾èµ–ï¼š**
- state-manager.js
- api-config.js

**éªŒè¯æµç¨‹ï¼š**
```
å‘é€éªŒè¯ç è¯·æ±‚
    â†“
ä¿å­˜refåˆ°çŠ¶æ€
    â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    â†“
éªŒè¯å¹¶è·å–ç­¾å
    â†“
ä¿å­˜ç­¾ååˆ°çŠ¶æ€
```

#### 7. esim-service.js
**èŒè´£ï¼š** eSIMç›¸å…³çš„æ‰€æœ‰ä¸šåŠ¡æ“ä½œ

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `getMemberInfo()` - è·å–ä¼šå‘˜ä¿¡æ¯
- `reserveESim()` - é¢„è®¢eSIM
- `swapSim()` - äº¤æ¢SIMå¡
- `getESimDownloadToken()` - è·å–LPA
- `autoActivateESim()` - è‡ªåŠ¨æ¿€æ´»
- `smsActivateFlow()` - å®Œæ•´SMSæ¿€æ´»æµç¨‹

**ä¾èµ–ï¼š**
- state-manager.js
- api-config.js

**SMSæ¿€æ´»å®Œæ•´æµç¨‹ï¼š**
```
å‘é€çŸ­ä¿¡éªŒè¯ç 
    â†“
éªŒè¯çŸ­ä¿¡éªŒè¯ç  â†’ è·å–ç­¾å
    â†“
é¢„è®¢eSIM â†’ è·å–æ¿€æ´»ç å’ŒSSN
    â†“
æ‰§è¡ŒSIMäº¤æ¢ â†’ æ¿€æ´»æ–°eSIM
    â†“
è½®è¯¢è·å–LPA â†’ ç”ŸæˆäºŒç»´ç 
```

### ç¬¬ä¸‰å±‚ï¼šUIæ§åˆ¶å±‚

#### 8. ui-controller.js
**èŒè´£ï¼š** UIçŠ¶æ€ç®¡ç†å’Œç”¨æˆ·äº¤äº’

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `showStatus()` - æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
- `updateSteps()` - æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
- `showSection()` - åˆ‡æ¢æ­¥éª¤
- `updateStatusPanel()` - æ›´æ–°çŠ¶æ€é¢æ¿
- `showMemberInfo()` - æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
- `showESIMInfoAndGuide()` - æ˜¾ç¤ºeSIMä¿¡æ¯
- `generateQRCode()` - ç”ŸæˆäºŒç»´ç 
- `showESimResult()` - æ˜¾ç¤ºæœ€ç»ˆç»“æœ

**ä¾èµ–ï¼š**
- state-manager.js

**UIæ›´æ–°æœºåˆ¶ï¼š**
```
çŠ¶æ€å˜æ›´ (state-manager)
    â†“
è§¦å‘è®¢é˜…å›è°ƒ
    â†“
ui-controller.updateStatusPanel()
    â†“
æ›´æ–°DOMæ˜¾ç¤º
```

### ç¬¬å››å±‚ï¼šåº”ç”¨å…¥å£å±‚

#### 9. giffgaff-app.js
**èŒè´£ï¼š** åº”ç”¨åˆå§‹åŒ–å’Œäº‹ä»¶åè°ƒ

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
- ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
- åè°ƒæ¨¡å—é—´äº¤äº’
- å¤„ç†ç”¨æˆ·æ“ä½œ

**åˆå§‹åŒ–æµç¨‹ï¼š**
```
é¡µé¢åŠ è½½
    â†“
åˆ›å»ºGiffgaffAppå®ä¾‹
    â†“
è®¢é˜…çŠ¶æ€å˜åŒ–
    â†“
ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
    â†“
åˆå§‹åŒ–æœåŠ¡æ—¶é—´æ£€æŸ¥
    â†“
æ¢å¤ä¼šè¯ï¼ˆå¦‚æœ‰ï¼‰
    â†“
æ›´æ–°UIæ˜¾ç¤º
    â†“
åº”ç”¨å°±ç»ª
```

## ğŸ”„ æ•°æ®æµå‘

### å…¸å‹æ“ä½œæµç¨‹ç¤ºä¾‹

#### OAuthç™»å½•æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹OAuthç™»å½•"
    â†“
giffgaff-app.handleOAuthLogin()
    â†“
oauth-handler.startOAuthLogin()
    â”œâ”€â†’ utils.generateCodeVerifier()
    â”œâ”€â†’ utils.generateCodeChallenge()
    â””â”€â†’ state-manager.set('codeVerifier', ...)
    â†“
æ‰“å¼€æˆæƒé¡µé¢
    â†“
ç”¨æˆ·è¾“å…¥å›è°ƒURL
    â†“
giffgaff-app.handleOAuthCallback()
    â†“
oauth-handler.processCallback()
    â”œâ”€â†’ è§£æcodeå’Œstate
    â”œâ”€â†’ ä»state-manageræ¢å¤verifier
    â”œâ”€â†’ è°ƒç”¨tokenäº¤æ¢API (api-config)
    â””â”€â†’ state-manager.set('accessToken', ...)
    â†“
ui-controller.showSection(2)
```

#### çŸ­ä¿¡æ¿€æ´»æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"çŸ­ä¿¡éªŒè¯ç æ¿€æ´»"
    â†“
giffgaff-app.handleSmsSend()
    â†“
mfa-handler.sendSimSwapMFAChallenge()
    â”œâ”€â†’ è°ƒç”¨GraphQL API (api-config)
    â””â”€â†’ state-manager.set('emailCodeRef', ...)
    â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    â†“
giffgaff-app.handleSmsVerify()
    â†“
esim-service.smsActivateFlow()
    â”œâ”€â†’ mfa-handler.validateMFACode()
    â”œâ”€â†’ esim-service.reserveESim()
    â”œâ”€â†’ esim-service.swapSim()
    â””â”€â†’ esim-service.waitAndGetLPA()
    â†“
ui-controller.showESimResult()
```

## ğŸ¯ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. å•ä¾‹æ¨¡å¼ (Singleton)
æ‰€æœ‰æ¨¡å—éƒ½å¯¼å‡ºå•ä¾‹å®ä¾‹ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€ï¼š
```javascript
export const stateManager = new StateManager();
export const uiController = new UIController();
// ...
```

### 2. è§‚å¯Ÿè€…æ¨¡å¼ (Observer)
çŠ¶æ€ç®¡ç†ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼é€šçŸ¥UIæ›´æ–°ï¼š
```javascript
stateManager.subscribe((state) => {
    uiController.updateStatusPanel();
});
```

### 3. ç­–ç•¥æ¨¡å¼ (Strategy)
ä¸åŒçš„ç™»å½•æ–¹å¼ï¼ˆOAuth/Cookieï¼‰ä½¿ç”¨ä¸åŒçš„å¤„ç†å™¨

### 4. å¤–è§‚æ¨¡å¼ (Facade)
`giffgaff-app.js` ä½œä¸ºå¤–è§‚ï¼Œç®€åŒ–æ¨¡å—é—´äº¤äº’

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### ES6æ¨¡å—ç³»ç»Ÿ
```javascript
// å¯¼å‡º
export class MyClass { }
export const myInstance = new MyClass();
export function myFunction() { }

// å¯¼å…¥
import { myInstance, myFunction } from './module.js';
```

### å¼‚æ­¥å¤„ç†
æ‰€æœ‰APIè°ƒç”¨ä½¿ç”¨ `async/await`ï¼š
```javascript
async handleOperation() {
    try {
        const result = await apiCall();
        // å¤„ç†ç»“æœ
    } catch (error) {
        // é”™è¯¯å¤„ç†
    }
}
```

### çŠ¶æ€ç®¡ç†
é›†ä¸­å¼çŠ¶æ€ + è®¢é˜…æ¨¡å¼ï¼š
```javascript
// æ›´æ–°çŠ¶æ€
stateManager.set('key', 'value');

// è‡ªåŠ¨è§¦å‘æ‰€æœ‰è®¢é˜…è€…
subscribers.forEach(fn => fn(state));
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç‚¹

### 1. èµ„æºåŠ è½½
- CSSæ–‡ä»¶å¯å¹¶è¡ŒåŠ è½½
- JavaScriptæ¨¡å—æŒ‰éœ€åŠ è½½
- é¢„è¿æ¥å…³é”®åŸŸå

### 2. ä»£ç åˆ†å‰²
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹æ–‡ä»¶
- æµè§ˆå™¨å¯ç¼“å­˜å•ä¸ªæ¨¡å—
- ä¿®æ”¹ä¸€ä¸ªæ¨¡å—ä¸å½±å“å…¶ä»–ç¼“å­˜

### 3. è¿è¡Œæ—¶ä¼˜åŒ–
- å‡å°‘å…¨å±€å˜é‡
- äº‹ä»¶å§”æ‰˜å‡å°‘ç›‘å¬å™¨
- é˜²æŠ–å’ŒèŠ‚æµï¼ˆå¦‚éœ€è¦ï¼‰

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†ç­–ç•¥

### åˆ†å±‚é”™è¯¯å¤„ç†

```
ç”¨æˆ·æ“ä½œ
    â†“
giffgaff-app (æ•è·å¹¶æ˜¾ç¤ºç”¨æˆ·å‹å¥½æ¶ˆæ¯)
    â†“
æœåŠ¡æ¨¡å— (æ•è·å¹¶è½¬æ¢APIé”™è¯¯)
    â†“
APIè°ƒç”¨ (åŸå§‹é”™è¯¯)
```

### é”™è¯¯ç±»å‹

1. **ç½‘ç»œé”™è¯¯** - æ˜¾ç¤º"ç½‘ç»œè¿æ¥å¤±è´¥"
2. **APIé”™è¯¯** - æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
3. **éªŒè¯é”™è¯¯** - æ˜¾ç¤ºè¡¨å•éªŒè¯æç¤º
4. **çŠ¶æ€é”™è¯¯** - å¼•å¯¼ç”¨æˆ·å›åˆ°æ­£ç¡®æ­¥éª¤

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ•æ„Ÿæ•°æ®å¤„ç†
- Access Tokenä»…å­˜å‚¨åœ¨å†…å­˜å’ŒlocalStorage
- Cookieä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
- å®šæœŸæ£€æŸ¥Cookieæœ‰æ•ˆæ€§

### 2. XSSé˜²æŠ¤
- ä½¿ç”¨ `textContent` è€Œé `innerHTML`ï¼ˆé™¤éå¿…è¦ï¼‰
- CSPç­–ç•¥é™åˆ¶è„šæœ¬æ¥æº
- ç”¨æˆ·è¾“å…¥éªŒè¯

### 3. CSRFé˜²æŠ¤
- ä½¿ç”¨PKCEæµç¨‹
- Stateå‚æ•°éªŒè¯
- TurnstileäººæœºéªŒè¯

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼

1. åˆ›å»ºæ–°çš„handleræ¨¡å—ï¼š
```javascript
// new-auth-handler.js
export class NewAuthHandler {
    async authenticate() {
        // å®ç°è®¤è¯é€»è¾‘
    }
}
export const newAuthHandler = new NewAuthHandler();
```

2. åœ¨ `giffgaff-app.js` ä¸­é›†æˆï¼š
```javascript
import { newAuthHandler } from './modules/new-auth-handler.js';

bindNewAuthMethod() {
    element.addEventListener('click', async () => {
        const result = await newAuthHandler.authenticate();
        // å¤„ç†ç»“æœ
    });
}
```

### æ·»åŠ æ–°çš„APIç«¯ç‚¹

1. åœ¨ `api-config.js` ä¸­æ·»åŠ ï¼š
```javascript
export function getApiEndpoints() {
    return {
        // ç°æœ‰ç«¯ç‚¹...
        newEndpoint: "/bff/new-endpoint"
    };
}
```

2. åœ¨å¯¹åº”æœåŠ¡æ¨¡å—ä¸­ä½¿ç”¨ï¼š
```javascript
async callNewEndpoint() {
    const response = await fetch(this.apiEndpoints.newEndpoint, {
        // è¯·æ±‚é…ç½®
    });
    return await response.json();
}
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```javascript
// state-manager.test.js
import { StateManager } from './state-manager.js';

describe('StateManager', () => {
    let manager;
    
    beforeEach(() => {
        manager = new StateManager();
        localStorage.clear();
    });
    
    test('åº”è¯¥æ­£ç¡®ä¿å­˜å’Œæ¢å¤ä¼šè¯', () => {
        manager.setState({ accessToken: 'test-token' });
        manager.saveSession();
        
        const newManager = new StateManager();
        const restored = newManager.loadSession();
        
        expect(restored).toBe(true);
        expect(newManager.get('accessToken')).toBe('test-token');
    });
    
    test('åº”è¯¥åœ¨è¶…æ—¶åæ¸…é™¤ä¼šè¯', () => {
        manager.setState({ accessToken: 'test-token' });
        manager.saveSession();
        
        // æ¨¡æ‹Ÿè¶…æ—¶
        const sessionData = JSON.parse(localStorage.getItem('giffgaff_session'));
        sessionData.timestamp = Date.now() - (3 * 60 * 60 * 1000); // 3å°æ—¶å‰
        localStorage.setItem('giffgaff_session', JSON.stringify(sessionData));
        
        const newManager = new StateManager();
        const restored = newManager.loadSession();
        
        expect(restored).toBe(false);
    });
});
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹

```javascript
// oauth-flow.test.js
import { oauthHandler } from './oauth-handler.js';
import { stateManager } from './state-manager.js';

describe('OAuth Flow', () => {
    test('å®Œæ•´OAuthæµç¨‹', async () => {
        // 1. å¯åŠ¨ç™»å½•
        const loginResult = await oauthHandler.startOAuthLogin();
        expect(loginResult.success).toBe(true);
        expect(stateManager.get('codeVerifier')).toBeTruthy();
        
        // 2. æ¨¡æ‹Ÿå›è°ƒ
        const mockCallback = 'giffgaff://auth/callback/?code=TEST&state=STATE';
        const callbackResult = await oauthHandler.processCallback(mockCallback);
        
        expect(callbackResult.success).toBe(true);
        expect(stateManager.get('accessToken')).toBeTruthy();
    });
});
```

## ğŸ“ ä»£ç è§„èŒƒ

### å‘½åçº¦å®š
- **ç±»å**ï¼šPascalCase (`StateManager`)
- **å‡½æ•°å**ï¼šcamelCase (`getMemberInfo`)
- **å¸¸é‡**ï¼šUPPER_SNAKE_CASE (`SESSION_KEY`)
- **ç§æœ‰æ–¹æ³•**ï¼šå‰ç¼€ä¸‹åˆ’çº¿ (`_privateMethod`)

### æ³¨é‡Šè§„èŒƒ
```javascript
/**
 * å‡½æ•°åŠŸèƒ½æè¿°
 * @param {string} param1 - å‚æ•°è¯´æ˜
 * @returns {Promise<Object>} è¿”å›å€¼è¯´æ˜
 */
async functionName(param1) {
    // å®ç°
}
```

### é”™è¯¯å¤„ç†
```javascript
try {
    const result = await operation();
    return { success: true, data: result };
} catch (error) {
    console.error('æ“ä½œå¤±è´¥:', error);
    throw error; // æˆ–è¿”å›é”™è¯¯å¯¹è±¡
}
```

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒ
1. ä½¿ç”¨Webpack/Rollupæ‰“åŒ…æ‰€æœ‰æ¨¡å—
2. å¯ç”¨ä»£ç å‹ç¼©å’Œæ··æ·†
3. ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº
4. å¯ç”¨HTTP/2æœåŠ¡å™¨æ¨é€

### å¼€å‘ç¯å¢ƒ
1. ç›´æ¥ä½¿ç”¨ES6æ¨¡å—ï¼ˆæ— éœ€æ‰“åŒ…ï¼‰
2. å¯ç”¨Source Mapè°ƒè¯•
3. ä½¿ç”¨çƒ­é‡è½½æå‡å¼€å‘æ•ˆç‡

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0.0  
**æœ€åæ›´æ–°ï¼š** 2025-10-31  
**ç»´æŠ¤è€…ï¼š** eSIM Tools Team