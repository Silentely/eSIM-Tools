<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    
    <!-- 预连接优化 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://qrcode.show" crossorigin>
    <link rel="preconnect" href="https://appapi.simyo.nl" crossorigin>
    
    <!-- CSP策略 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' data: https://cdnjs.cloudflare.com; connect-src 'self' https://qrcode.show https://api.qrserver.com https://appapi.simyo.nl; img-src 'self' data: https:; frame-src 'none';">
    
    <title>Simyo NL eSIM 申请工具</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#ff6b00">
    <link rel="icon" href="/src/assets/favicon.ico" type="image/x-icon">
    
    <!-- 外部样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/src/assets/fontawesome/all.min.css">
    
    <!-- 共享设计系统 -->
    <link rel="preload" href="/src/styles/design-system.css" as="style" onload="this.rel='stylesheet'">
    <link rel="preload" href="/src/styles/animations.css" as="style" onload="this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="/src/styles/design-system.css">
        <link rel="stylesheet" href="/src/styles/animations.css">
    </noscript>
    
    <!-- Simyo专用样式 -->
    <link rel="stylesheet" href="/src/simyo/styles/simyo-base.css">
    <link rel="stylesheet" href="/src/simyo/styles/simyo-components.css">
    <link rel="stylesheet" href="/src/simyo/styles/simyo-animations.css">
    <link rel="stylesheet" href="/src/simyo/styles/simyo-responsive.css">
</head>
<body>
    <div class="container main-container">
        <!-- 应用头部 -->
        <div class="app-header">
            <div class="logo-container">
                <i class="fas fa-sim-card app-icon" aria-hidden="true"></i>
                <div class="app-title">Simyo eSIM工具</div>
            </div>
            <div class="header-buttons">
                <button class="help-btn" onclick="openHelp()" aria-label="打开使用帮助">
                    <i class="fas fa-question-circle" aria-hidden="true"></i> 使用帮助
                </button>
                <a href="https://github.com/Silentely/eSIM-Tools" target="_blank" class="github-btn" aria-label="打开GitHub仓库">
                    <i class="fab fa-github" aria-hidden="true"></i> GitHub
                </a>
            </div>
        </div>

        <!-- 开卡推广 -->
        <div class="promo-banner reveal">
            <div class="promo-content">
                <i class="fas fa-gift promo-icon" aria-hidden="true"></i>
                <span class="promo-text">
                    如果您还没有开卡，可以<a href="https://vriendendeal.simyo.nl/prepaid/AZzwPzb" target="_blank" class="promo-link">点击这里开卡</a>，享受额外5欧元话费赠送！
                </span>
            </div>
        </div>
        
        <!-- 页面标题 -->
        <div class="page-title reveal">
            <h1>Simyo NL eSIM 申请工具</h1>
            <p>轻松管理您的Simyo eSIM配置</p>
            <div id="modeBadge" class="mode-badge" style="display:none" aria-live="polite">
                <i class="fas fa-exchange-alt" aria-hidden="true"></i> 设备更换模式
            </div>
        </div>
        
        <!-- 状态显示面板 -->
        <div class="status-panel card-elevated reveal" role="status" aria-live="polite">
            <h3><i class="fas fa-info-circle" aria-hidden="true"></i> 当前状态</h3>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">当前模式:</span>
                    <span id="statusMode" class="status-value connected">标准流程</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Session Token:</span>
                    <span id="statusSessionToken" class="status-value disconnected">未登录</span>
                </div>
                <div class="status-item">
                    <span class="status-label">验证码状态:</span>
                    <span id="statusValidationCode" class="status-value disconnected">未发送</span>
                </div>
                <div class="status-item">
                    <span class="status-label">eSIM状态:</span>
                    <span id="statusEsimStatus" class="status-value disconnected">未申请</span>
                </div>
                <div class="status-item">
                    <span class="status-label">激活码:</span>
                    <span id="statusActivationCode" class="status-value disconnected">未获取</span>
                </div>
                <div class="status-item">
                    <span class="status-label">LPA字符串:</span>
                    <span id="statusLpaString" class="status-value disconnected">未生成</span>
                </div>
            </div>
            <button id="clearSessionBtn" class="clear-session-btn" aria-label="清除会话并重置所有进度">
                <i class="fas fa-trash-alt" aria-hidden="true"></i> 清除会话
            </button>
        </div>
        
        <!-- 使用说明 -->
        <div class="info-card reveal">
            <h6><i class="fas fa-info-circle" aria-hidden="true"></i> 使用说明</h6>
            <p><strong>初次注册并安装：</strong>直接使用步骤1-3即可完成</p>
            <p><strong>更换设备：</strong>在APP中申请更换设备后，使用本工具生成二维码，新设备扫码安装</p>
            <p><strong>保号服务：</strong>向IBAN:NL19INGB0007811670转账0.01欧元，备注您的Simyo号码</p>
        </div>
        
        <!-- 步骤指示器 -->
        <div class="step-indicator reveal" role="list" aria-label="进度步骤">
            <div class="step active" role="listitem" aria-current="step" data-step="1">
                <div class="step-number" aria-hidden="true">1</div>
                <div class="step-text">账户登录</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-text">获取eSIM</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-text">生成二维码</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-text">确认安装</div>
            </div>
        </div>
        
        <!-- 步骤1: 账户登录 -->
        <div id="step1" class="section active reveal">
            <div class="card card-elevated">
                <div class="card-header">
                    <i class="fas fa-sign-in-alt"></i> 第一步：登录Simyo账户
                </div>
                <div class="card-body">
                    <p class="mb-4" style="font-size: 17px; color: #212529;">
                        请输入您的Simyo账户信息进行登录：
                    </p>
                    
                    <div class="mb-4">
                        <label for="phoneNumber" class="form-label">手机号码：</label>
                        <input type="text" id="phoneNumber" class="form-control" placeholder="例如: 0613123712" maxlength="15" aria-describedby="phoneHelp">
                        <small id="phoneHelp" class="text-muted">荷兰手机号，06开头共10位数字</small>
                    </div>
                    
                    <div class="mb-4">
                        <label for="password" class="form-label">密码：</label>
                        <input type="password" id="password" class="form-control" placeholder="输入您的Simyo密码" aria-describedby="pwdHelp">
                        <small id="pwdHelp" class="text-muted">仅用于向官方接口鉴权，不会被本页面保存</small>
                    </div>
                    
                    <div class="btn-group">
                        <button id="loginBtn" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i> 登录账户
                        </button>
                    </div>
                    
                    <div id="loginStatus" class="status" role="status" aria-live="polite"></div>
                </div>
            </div>
        </div>
        
        <!-- 设备更换选项 -->
        <div id="deviceChangeOption" class="section reveal" style="display: none;">
            <div class="card card-elevated">
                <div class="card-header">
                    <i class="fas fa-mobile-alt"></i> 设备更换选项
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle me-2" aria-hidden="true"></i>选择操作类型</h5>
                        <p>请选择您的需求：</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-exchange-alt fa-3x text-warning mb-3" aria-hidden="true"></i>
                                    <h5>更换设备</h5>
                                    <p class="text-muted">将eSIM转移到新设备</p>
                                    <button class="btn btn-primary w-100" onclick="startDeviceChange()">
                                        选择此选项
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-sim-card fa-3x text-success mb-3" aria-hidden="true"></i>
                                    <h5>直接获取eSIM</h5>
                                    <p class="text-muted">首次申请或当前设备使用</p>
                                    <button class="btn btn-primary w-100" onclick="skipDeviceChange()">
                                        选择此选项
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设备更换流程 -->
        <div id="deviceChangeSteps" class="section reveal" style="display: none;">
            <div class="card card-elevated">
                <div class="card-header">
                    <i class="fas fa-exchange-alt" aria-hidden="true"></i> 设备更换流程
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>重要提示</h5>
                        <ul class="mb-0">
                            <li><strong>如果您的现有eSIM能接收短信：</strong>请按顺序执行申请新eSIM，然后发送验证码到短信</li>
                            <li><strong>如果您的现有eSIM无法接收短信：</strong>只执行申请新eSIM，然后联系Simyo客服索要验证码</li>
                        </ul>
                    </div>

                    <!-- Step 2.1: 申请新eSIM -->
                    <div class="mb-4">
                        <h5>2.1 申请新eSIM</h5>
                        <p>此步骤会通知Simyo系统您要更换eSIM设备</p>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="applyNewEsimBtn">
                                <i class="fas fa-plus me-2"></i>申请新eSIM
                            </button>
                        </div>
                        <div id="applyNewEsimStatus" class="status" role="status" aria-live="polite"></div>
                    </div>

                    <!-- Step 2.2: 发送验证码 -->
                    <div class="mb-4">
                        <h5>2.2 发送验证码到短信（可选）</h5>
                        <p>如果您能接收短信，在执行完2.1成功后，立即执行此步骤</p>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="sendSmsBtn" disabled>
                                <i class="fas fa-sms me-2"></i>发送验证码到短信
                            </button>
                        </div>
                        <div id="sendSmsStatus" class="status" role="status" aria-live="polite"></div>
                    </div>

                    <!-- Step 2.3: 验证验证码 -->
                    <div class="mb-4">
                        <h5>2.3 确认验证码</h5>
                        <p>无论您是通过短信收到验证码还是从客服处获取，请在此处填写验证码并确认</p>
                        <div class="mb-3">
                            <label for="validationCodeInput" class="form-label">验证码：</label>
                            <input type="text" class="form-control" id="validationCodeInput" 
                                   placeholder="输入6位数字验证码" maxlength="6" pattern="^\d{6}$">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="verifyCodeBtn" disabled>
                                <i class="fas fa-check me-2"></i>确认验证码
                            </button>
                        </div>
                        <div id="verifyCodeStatus" class="status" role="status" aria-live="polite"></div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary" onclick="skipDeviceChange()">
                            <i class="fas fa-skip-forward me-2"></i>跳过设备更换，直接获取eSIM
                        </button>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                        <button id="backToDeviceChangeOptionBtn" type="button" class="btn btn-link" aria-label="返回设备更换选项">
                            ← 返回设备更换选项
                        </button>
                        <button type="button" class="btn btn-link back-step-btn" aria-label="返回上一步">
                            ← 返回上一步
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 步骤2: 获取eSIM -->
        <div id="step2" class="section reveal">
            <div class="card card-elevated">
                <div class="card-header">
                    <i class="fas fa-download"></i> 第二步：获取eSIM信息
                </div>
                <div class="card-body">
                    <p class="mb-4" style="font-size: 17px; color: #212529;">
                        获取您的eSIM配置信息：
                    </p>
                    
                    <div class="btn-group">
                        <button id="getEsimBtn" class="btn btn-primary">
                            <i class="fas fa-sim-card me-2"></i> 获取eSIM
                        </button>
                    </div>
                    
                    <div id="esimStatus" class="status" role="status" aria-live="polite"></div>
                    <div id="esimInfo" class="mt-4"></div>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-link back-step-btn" aria-label="返回上一步">
                            ← 返回上一步
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 步骤3: 生成二维码 -->
        <div id="step3" class="section reveal">
            <div class="card card-elevated">
                <div class="card-header">
                    <i class="fas fa-qrcode" aria-hidden="true"></i> 第三步：生成eSIM二维码
                </div>
                <div class="card-body">
                    <p class="mb-4" style="font-size: 17px; color: #212529;">
                        生成eSIM二维码供设备扫描安装：
                    </p>
                    
                    <div class="btn-group">
                        <button id="generateQrBtn" class="btn btn-primary">
                            <i class="fas fa-qrcode me-2"></i> 生成二维码
                        </button>
                    </div>
                    
                    <div id="qrStatus" class="status" role="status" aria-live="polite"></div>
                    
                    <!-- eSIM二维码显示 -->
                    <div id="resultContainer" class="mt-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-qrcode me-2" aria-hidden="true"></i> 您的eSIM二维码
                            </div>
                            <div class="card-body text-center">
                                <div id="qrcode" class="mt-4"></div>
                                <div id="activationInfo" class="mt-4"></div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-link back-step-btn" aria-label="返回上一步">
                            ← 返回上一步
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 步骤4: 确认安装 -->
        <div id="step4" class="section reveal">
            <div class="card card-elevated">
                <div class="card-header">
                    <i class="fas fa-check-circle" aria-hidden="true"></i> 第四步：确认安装（可选）
                </div>
                <div class="card-body">
                    <p class="mb-4" style="font-size: 17px; color: #212529;">
                        如果APP无法登录或更换设备，请执行此步骤确认安装：
                    </p>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                        <strong>说明：</strong>此步骤适用于更换设备或APP登录异常的情况
                    </div>
                    
                    <div class="btn-group">
                        <button id="confirmInstallBtn" class="btn btn-primary">
                            <i class="fas fa-check me-2"></i> 确认安装
                        </button>
                    </div>
                    
                    <div id="confirmStatus" class="status" role="status" aria-live="polite"></div>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-link back-step-btn" aria-label="返回上一步">
                            ← 返回上一步
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 外部脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 入场动效 -->
    <script>
        (function(){
            const initReveal = () => {
                const nodes = document.querySelectorAll('.reveal');
                if (!nodes.length) return;
                if ('IntersectionObserver' in window) {
                    const io = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('show');
                                io.unobserve(entry.target);
                            }
                        });
                    }, { rootMargin: '0px 0px -10% 0px', threshold: 0.1 });
                    nodes.forEach(el => io.observe(el));
                } else {
                    nodes.forEach(el => el.classList.add('show'));
                }
            };
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initReveal, { once: true });
            } else {
                initReveal();
            }
        })();
    </script>
    
    <!-- 主应用脚本（模块化） -->
    <script type="module" src="/src/simyo/js/simyo-app.js"></script>
    
    <!-- 统一版权页脚 -->
    <script type="module" src="/src/js/bootstrap-footer.js"></script>
</body>
</html>